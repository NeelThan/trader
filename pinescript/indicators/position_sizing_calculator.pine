// Position Sizing & Risk-Reward Calculator
// Calculates recommended position size and displays detailed calculation breakdown
//
// IMPORTANT: Pine Script cannot access your live broker account balance.
// You must manually enter your account size in the settings.
//
// This indicator is designed to help you LEARN the math behind position sizing
// by showing every step of the calculation process.

//@version=6
indicator("Position Sizing & R:R Calculator", overlay=true, max_labels_count=50, max_lines_count=50)

// =============================================================================
// INPUTS
// =============================================================================

grpAccount = "═══ ACCOUNT ═══"
accountSize = input.float(10000, "Account Size ($)", minval=100, step=100, group=grpAccount,
    tooltip="Enter your trading account balance in USD")
riskPercent = input.float(1.0, "Risk Per Trade (%)", minval=0.1, maxval=10, step=0.1, group=grpAccount,
    tooltip="Maximum percentage of account to risk per trade (1-2% recommended)")

grpTrade = "═══ TRADE SETUP ═══"
useCurrentPrice = input.bool(true, "Use Current Price as Entry", group=grpTrade)
manualEntry = input.float(0, "Manual Entry Price", minval=0, group=grpTrade,
    tooltip="Only used if 'Use Current Price' is disabled")
stopLossPrice = input.float(0, "Stop Loss Price", minval=0, group=grpTrade,
    tooltip="Enter your stop loss price level")
tradeDirection = input.string("Long", "Trade Direction", options=["Long", "Short"], group=grpTrade)

grpTargets = "═══ TARGETS (R:R) ═══"
target1Price = input.float(0, "Target 1 (T1) Price", minval=0, group=grpTargets,
    tooltip="First profit target price")
target2Price = input.float(0, "Target 2 (T2) Price", minval=0, group=grpTargets,
    tooltip="Second profit target price")
target3Price = input.float(0, "Target 3 (T3) Price", minval=0, group=grpTargets,
    tooltip="Third profit target price")

grpInstrument = "═══ INSTRUMENT ═══"
instrumentType = input.string("Indices", "Instrument Type",
    options=["Indices", "Forex", "Stocks/ETFs", "Crypto", "Futures", "CFD"], group=grpInstrument,
    tooltip="Indices: DJI, SPX, NDX, etc. Forex: Currency pairs. Futures: ES, NQ, YM, etc.")
contractSize = input.float(100000, "Contract Size", minval=1, group=grpInstrument,
    tooltip="Forex: Standard=100000, Mini=10000, Micro=1000")
tickValue = input.float(12.50, "Tick Value ($) - Futures", minval=0.01, group=grpInstrument,
    tooltip="Dollar value per tick (e.g., ES=$12.50, NQ=$5.00)")
tickSize = input.float(0.25, "Tick Size - Futures", minval=0.0001, group=grpInstrument,
    tooltip="Minimum price movement (e.g., ES=0.25, NQ=0.25)")

grpDisplay = "═══ DISPLAY ═══"
showMainTable = input.bool(true, "Show Main Table", group=grpDisplay)
showFormulaTable = input.bool(true, "Show Formula Breakdown", group=grpDisplay,
    tooltip="Educational breakdown of each calculation step")
showRRTable = input.bool(true, "Show R:R Table", group=grpDisplay)
tablePosition = input.string("Top Center", "Main Table Position",
    options=["Top Center", "Top Right", "Top Left", "Bottom Right", "Bottom Left", "Bottom Center"], group=grpDisplay)
showLines = input.bool(true, "Show Entry/Stop/Target Lines", group=grpDisplay)

// =============================================================================
// CORE CALCULATIONS
// =============================================================================

// Entry price
entryPrice = useCurrentPrice ? close : manualEntry

// Validation
validEntry = entryPrice > 0
validStop = stopLossPrice > 0
validTrade = validEntry and validStop and entryPrice != stopLossPrice
stopIsValid = tradeDirection == "Long" ? stopLossPrice < entryPrice : stopLossPrice > entryPrice

// === STEP 1: Calculate Risk Amount ===
// Formula: Risk Amount = Account Size × (Risk Percentage / 100)
riskAmount = accountSize * (riskPercent / 100)

// === STEP 2: Calculate Stop Distance ===
// Formula: Stop Distance = |Entry Price - Stop Loss Price|
stopDistance = math.abs(entryPrice - stopLossPrice)
stopDistancePercent = validEntry ? (stopDistance / entryPrice) * 100 : 0

// === STEP 3: Calculate Position Size ===
// Formula: Position Size = Risk Amount / Stop Distance
var float positionSize = 0.0
var float lotSize = 0.0
var float dollarValue = 0.0
var float riskPerUnit = 0.0

if validTrade and stopIsValid
    if instrumentType == "Forex"
        positionSize := riskAmount / stopDistance
        lotSize := positionSize / contractSize
        dollarValue := positionSize * entryPrice
        riskPerUnit := stopDistance

    else if instrumentType == "Indices"
        // For indices (DJI, SPX, NDX), position size = number of units/contracts
        // Risk per unit = stop distance in points
        // Example: DJI at 42000, stop 100 points away, risk $100 = 1 unit
        positionSize := riskAmount / stopDistance
        lotSize := positionSize
        dollarValue := positionSize * entryPrice
        riskPerUnit := stopDistance

    else if instrumentType == "Stocks/ETFs" or instrumentType == "CFD" or instrumentType == "Crypto"
        positionSize := riskAmount / stopDistance
        lotSize := positionSize
        dollarValue := positionSize * entryPrice
        riskPerUnit := stopDistance

    else if instrumentType == "Futures"
        ticksInStop = stopDistance / tickSize
        riskPerContract = ticksInStop * tickValue
        lotSize := riskPerContract > 0 ? riskAmount / riskPerContract : 0
        positionSize := lotSize
        dollarValue := lotSize * entryPrice
        riskPerUnit := riskPerContract

// === STEP 4: Calculate Risk-Reward Ratios ===
// Formula: R:R = (Target - Entry) / (Entry - Stop) for Long
//          R:R = (Entry - Target) / (Stop - Entry) for Short

// Target distances and R:R
t1Distance = target1Price > 0 ? math.abs(target1Price - entryPrice) : 0.0
t2Distance = target2Price > 0 ? math.abs(target2Price - entryPrice) : 0.0
t3Distance = target3Price > 0 ? math.abs(target3Price - entryPrice) : 0.0

t1RR = stopDistance > 0 and t1Distance > 0 ? t1Distance / stopDistance : 0.0
t2RR = stopDistance > 0 and t2Distance > 0 ? t2Distance / stopDistance : 0.0
t3RR = stopDistance > 0 and t3Distance > 0 ? t3Distance / stopDistance : 0.0

// Validate targets are on correct side
t1Valid = target1Price > 0 and (tradeDirection == "Long" ? target1Price > entryPrice : target1Price < entryPrice)
t2Valid = target2Price > 0 and (tradeDirection == "Long" ? target2Price > entryPrice : target2Price < entryPrice)
t3Valid = target3Price > 0 and (tradeDirection == "Long" ? target3Price > entryPrice : target3Price < entryPrice)

// === STEP 5: Calculate Profit at Each Target ===
// Formula: Profit = Position Size × (Target - Entry) for Long
//          Profit = Position Size × (Entry - Target) for Short
t1Profit = t1Valid and validTrade ? positionSize * t1Distance : 0.0
t2Profit = t2Valid and validTrade ? positionSize * t2Distance : 0.0
t3Profit = t3Valid and validTrade ? positionSize * t3Distance : 0.0

// For futures, calculate differently
if instrumentType == "Futures" and validTrade
    t1Profit := t1Valid ? lotSize * (t1Distance / tickSize) * tickValue : 0.0
    t2Profit := t2Valid ? lotSize * (t2Distance / tickSize) * tickValue : 0.0
    t3Profit := t3Valid ? lotSize * (t3Distance / tickSize) * tickValue : 0.0

// =============================================================================
// TABLE POSITIONS
// =============================================================================

mainTablePos = switch tablePosition
    "Top Center" => position.top_center
    "Top Right" => position.top_right
    "Top Left" => position.top_left
    "Bottom Center" => position.bottom_center
    "Bottom Right" => position.bottom_right
    "Bottom Left" => position.bottom_left
    => position.top_center

// Formula table on opposite side (left when main is center/right, right when main is left)
formulaTablePos = switch tablePosition
    "Top Center" => position.top_left
    "Top Right" => position.top_left
    "Top Left" => position.top_right
    "Bottom Center" => position.bottom_left
    "Bottom Right" => position.bottom_left
    "Bottom Left" => position.bottom_right
    => position.top_left

// =============================================================================
// MAIN CALCULATION TABLE
// =============================================================================

var table mainTable = table.new(mainTablePos, 2, 18, bgcolor=color.new(color.black, 85), border_width=1)

if barstate.islast and showMainTable
    row = 0

    // Header
    table.cell(mainTable, 0, row, "POSITION", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(mainTable, 1, row, "SIZING", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 50))
    row += 1

    // Account Section
    table.cell(mainTable, 0, row, "Account", text_color=color.gray, text_size=size.tiny)
    table.cell(mainTable, 1, row, "$" + str.tostring(accountSize, "#,###"), text_color=color.white, text_size=size.small)
    row += 1

    table.cell(mainTable, 0, row, "Risk %", text_color=color.gray, text_size=size.tiny)
    table.cell(mainTable, 1, row, str.tostring(riskPercent, "#.##") + "%", text_color=color.yellow, text_size=size.small)
    row += 1

    table.cell(mainTable, 0, row, "$ at Risk", text_color=color.gray, text_size=size.tiny)
    table.cell(mainTable, 1, row, "$" + str.tostring(riskAmount, "#,###.##"), text_color=color.orange, text_size=size.small)
    row += 1

    // Divider
    table.cell(mainTable, 0, row, "── TRADE ──", text_color=color.gray, text_size=size.tiny)
    table.cell(mainTable, 1, row, "", text_size=size.tiny)
    row += 1

    // Trade Details
    dirColor = tradeDirection == "Long" ? color.lime : color.red
    table.cell(mainTable, 0, row, "Direction", text_color=color.gray, text_size=size.tiny)
    table.cell(mainTable, 1, row, tradeDirection, text_color=dirColor, text_size=size.small)
    row += 1

    table.cell(mainTable, 0, row, "Entry", text_color=color.gray, text_size=size.tiny)
    table.cell(mainTable, 1, row, str.tostring(entryPrice, format.mintick), text_color=color.white, text_size=size.small)
    row += 1

    stopColor = stopIsValid ? color.red : color.fuchsia
    table.cell(mainTable, 0, row, "Stop", text_color=color.gray, text_size=size.tiny)
    table.cell(mainTable, 1, row, validStop ? str.tostring(stopLossPrice, format.mintick) : "Enter stop", text_color=stopColor, text_size=size.small)
    row += 1

    table.cell(mainTable, 0, row, "Stop Dist", text_color=color.gray, text_size=size.tiny)
    table.cell(mainTable, 1, row, validTrade ? str.tostring(stopDistance, format.mintick) + " (" + str.tostring(stopDistancePercent, "#.##") + "%)" : "---", text_color=color.white, text_size=size.small)
    row += 1

    // Divider
    table.cell(mainTable, 0, row, "── SIZE ──", text_color=color.gray, text_size=size.tiny)
    table.cell(mainTable, 1, row, "", text_size=size.tiny)
    row += 1

    // Sizing Results
    table.cell(mainTable, 0, row, "Type", text_color=color.gray, text_size=size.tiny)
    table.cell(mainTable, 1, row, instrumentType, text_color=color.aqua, text_size=size.small)
    row += 1

    sizeLabel = instrumentType == "Forex" ? "Units" : (instrumentType == "Futures" ? "Contracts" : (instrumentType == "Indices" ? "Units" : "Shares"))
    table.cell(mainTable, 0, row, sizeLabel, text_color=color.gray, text_size=size.tiny)
    if validTrade and stopIsValid
        sizeText = instrumentType == "Forex" ? str.tostring(positionSize, "#,###") : str.tostring(lotSize, "#.##")
        table.cell(mainTable, 1, row, sizeText, text_color=color.lime, text_size=size.small)
    else
        table.cell(mainTable, 1, row, "---", text_color=color.gray, text_size=size.small)
    row += 1

    if instrumentType == "Forex"
        table.cell(mainTable, 0, row, "Lots", text_color=color.gray, text_size=size.tiny)
        table.cell(mainTable, 1, row, validTrade and stopIsValid ? str.tostring(lotSize, "#.###") : "---", text_color=color.lime, text_size=size.small)
        row += 1

    table.cell(mainTable, 0, row, "Value", text_color=color.gray, text_size=size.tiny)
    table.cell(mainTable, 1, row, validTrade and stopIsValid ? "$" + str.tostring(dollarValue, "#,###") : "---", text_color=color.white, text_size=size.small)
    row += 1

    // Warning if needed
    if not stopIsValid and validStop
        table.cell(mainTable, 0, row, "⚠️", text_color=color.fuchsia, text_size=size.small)
        warnText = tradeDirection == "Long" ? "Stop > Entry!" : "Stop < Entry!"
        table.cell(mainTable, 1, row, warnText, text_color=color.fuchsia, text_size=size.tiny)

// =============================================================================
// FORMULA BREAKDOWN TABLE (Educational)
// =============================================================================

var table formulaTable = table.new(formulaTablePos, 3, 20, bgcolor=color.new(color.black, 85), border_width=1)

if barstate.islast and showFormulaTable
    row = 0

    // Header
    table.cell(formulaTable, 0, row, "STEP", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.purple, 50))
    table.cell(formulaTable, 1, row, "FORMULA", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.purple, 50))
    table.cell(formulaTable, 2, row, "RESULT", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.purple, 50))
    row += 1

    // Step 1: Risk Amount
    table.cell(formulaTable, 0, row, "1", text_color=color.yellow, text_size=size.tiny)
    table.cell(formulaTable, 1, row, "Risk $ = Account × Risk%", text_color=color.gray, text_size=size.tiny)
    table.cell(formulaTable, 2, row, "", text_size=size.tiny)
    row += 1

    table.cell(formulaTable, 0, row, "", text_size=size.tiny)
    formula1 = "$" + str.tostring(accountSize, "#,###") + " × " + str.tostring(riskPercent, "#.##") + "%"
    table.cell(formulaTable, 1, row, formula1, text_color=color.white, text_size=size.tiny)
    table.cell(formulaTable, 2, row, "$" + str.tostring(riskAmount, "#.##"), text_color=color.orange, text_size=size.tiny)
    row += 1

    // Step 2: Stop Distance
    table.cell(formulaTable, 0, row, "2", text_color=color.yellow, text_size=size.tiny)
    table.cell(formulaTable, 1, row, "Stop Dist = |Entry - Stop|", text_color=color.gray, text_size=size.tiny)
    table.cell(formulaTable, 2, row, "", text_size=size.tiny)
    row += 1

    table.cell(formulaTable, 0, row, "", text_size=size.tiny)
    if validTrade
        formula2 = "|" + str.tostring(entryPrice, format.mintick) + " - " + str.tostring(stopLossPrice, format.mintick) + "|"
        table.cell(formulaTable, 1, row, formula2, text_color=color.white, text_size=size.tiny)
        table.cell(formulaTable, 2, row, str.tostring(stopDistance, format.mintick), text_color=color.red, text_size=size.tiny)
    else
        table.cell(formulaTable, 1, row, "Enter stop price", text_color=color.gray, text_size=size.tiny)
        table.cell(formulaTable, 2, row, "---", text_color=color.gray, text_size=size.tiny)
    row += 1

    // Step 3: Position Size
    table.cell(formulaTable, 0, row, "3", text_color=color.yellow, text_size=size.tiny)
    table.cell(formulaTable, 1, row, "Size = Risk $ ÷ Stop Dist", text_color=color.gray, text_size=size.tiny)
    table.cell(formulaTable, 2, row, "", text_size=size.tiny)
    row += 1

    table.cell(formulaTable, 0, row, "", text_size=size.tiny)
    if validTrade and stopIsValid
        formula3 = "$" + str.tostring(riskAmount, "#.##") + " ÷ " + str.tostring(stopDistance, format.mintick)
        table.cell(formulaTable, 1, row, formula3, text_color=color.white, text_size=size.tiny)
        table.cell(formulaTable, 2, row, str.tostring(positionSize, "#,###.##"), text_color=color.lime, text_size=size.tiny)
    else
        table.cell(formulaTable, 1, row, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(formulaTable, 2, row, "---", text_color=color.gray, text_size=size.tiny)
    row += 1

    // Step 4: Lot Size (Forex only)
    if instrumentType == "Forex"
        table.cell(formulaTable, 0, row, "4", text_color=color.yellow, text_size=size.tiny)
        table.cell(formulaTable, 1, row, "Lots = Size ÷ Contract", text_color=color.gray, text_size=size.tiny)
        table.cell(formulaTable, 2, row, "", text_size=size.tiny)
        row += 1

        table.cell(formulaTable, 0, row, "", text_size=size.tiny)
        if validTrade and stopIsValid
            formula4 = str.tostring(positionSize, "#,###") + " ÷ " + str.tostring(contractSize, "#,###")
            table.cell(formulaTable, 1, row, formula4, text_color=color.white, text_size=size.tiny)
            table.cell(formulaTable, 2, row, str.tostring(lotSize, "#.###") + " lots", text_color=color.lime, text_size=size.tiny)
        else
            table.cell(formulaTable, 1, row, "---", text_color=color.gray, text_size=size.tiny)
            table.cell(formulaTable, 2, row, "---", text_color=color.gray, text_size=size.tiny)
        row += 1

    // Divider for R:R
    table.cell(formulaTable, 0, row, "──", text_color=color.gray, text_size=size.tiny)
    table.cell(formulaTable, 1, row, "── RISK:REWARD ──", text_color=color.gray, text_size=size.tiny)
    table.cell(formulaTable, 2, row, "──", text_color=color.gray, text_size=size.tiny)
    row += 1

    // R:R Formula explanation
    table.cell(formulaTable, 0, row, "R:R", text_color=color.yellow, text_size=size.tiny)
    rrFormula = tradeDirection == "Long" ? "(Target - Entry) ÷ Stop" : "(Entry - Target) ÷ Stop"
    table.cell(formulaTable, 1, row, rrFormula, text_color=color.gray, text_size=size.tiny)
    table.cell(formulaTable, 2, row, "", text_size=size.tiny)
    row += 1

    // T1 R:R
    if target1Price > 0
        table.cell(formulaTable, 0, row, "T1", text_color=color.aqua, text_size=size.tiny)
        if t1Valid and validTrade
            t1Formula = str.tostring(t1Distance, format.mintick) + " ÷ " + str.tostring(stopDistance, format.mintick)
            table.cell(formulaTable, 1, row, t1Formula, text_color=color.white, text_size=size.tiny)
            rrColor = t1RR >= 2 ? color.lime : (t1RR >= 1 ? color.yellow : color.red)
            table.cell(formulaTable, 2, row, "1:" + str.tostring(t1RR, "#.##"), text_color=rrColor, text_size=size.tiny)
        else
            table.cell(formulaTable, 1, row, "Invalid target", text_color=color.red, text_size=size.tiny)
            table.cell(formulaTable, 2, row, "---", text_color=color.gray, text_size=size.tiny)
        row += 1

    // T2 R:R
    if target2Price > 0
        table.cell(formulaTable, 0, row, "T2", text_color=color.aqua, text_size=size.tiny)
        if t2Valid and validTrade
            t2Formula = str.tostring(t2Distance, format.mintick) + " ÷ " + str.tostring(stopDistance, format.mintick)
            table.cell(formulaTable, 1, row, t2Formula, text_color=color.white, text_size=size.tiny)
            rrColor = t2RR >= 2 ? color.lime : (t2RR >= 1 ? color.yellow : color.red)
            table.cell(formulaTable, 2, row, "1:" + str.tostring(t2RR, "#.##"), text_color=rrColor, text_size=size.tiny)
        else
            table.cell(formulaTable, 1, row, "Invalid target", text_color=color.red, text_size=size.tiny)
            table.cell(formulaTable, 2, row, "---", text_color=color.gray, text_size=size.tiny)
        row += 1

    // T3 R:R
    if target3Price > 0
        table.cell(formulaTable, 0, row, "T3", text_color=color.aqua, text_size=size.tiny)
        if t3Valid and validTrade
            t3Formula = str.tostring(t3Distance, format.mintick) + " ÷ " + str.tostring(stopDistance, format.mintick)
            table.cell(formulaTable, 1, row, t3Formula, text_color=color.white, text_size=size.tiny)
            rrColor = t3RR >= 2 ? color.lime : (t3RR >= 1 ? color.yellow : color.red)
            table.cell(formulaTable, 2, row, "1:" + str.tostring(t3RR, "#.##"), text_color=rrColor, text_size=size.tiny)
        else
            table.cell(formulaTable, 1, row, "Invalid target", text_color=color.red, text_size=size.tiny)
            table.cell(formulaTable, 2, row, "---", text_color=color.gray, text_size=size.tiny)
        row += 1

    // Profit Calculations
    if (t1Valid or t2Valid or t3Valid) and validTrade and stopIsValid
        table.cell(formulaTable, 0, row, "──", text_color=color.gray, text_size=size.tiny)
        table.cell(formulaTable, 1, row, "── PROFIT @ TARGET ──", text_color=color.gray, text_size=size.tiny)
        table.cell(formulaTable, 2, row, "──", text_color=color.gray, text_size=size.tiny)
        row += 1

        table.cell(formulaTable, 0, row, "P", text_color=color.yellow, text_size=size.tiny)
        table.cell(formulaTable, 1, row, "Profit = Size × Distance", text_color=color.gray, text_size=size.tiny)
        table.cell(formulaTable, 2, row, "", text_size=size.tiny)
        row += 1

        if t1Valid
            table.cell(formulaTable, 0, row, "T1", text_color=color.aqua, text_size=size.tiny)
            profitFormula = str.tostring(positionSize, "#.##") + " × " + str.tostring(t1Distance, format.mintick)
            table.cell(formulaTable, 1, row, profitFormula, text_color=color.white, text_size=size.tiny)
            table.cell(formulaTable, 2, row, "$" + str.tostring(t1Profit, "#,###.##"), text_color=color.lime, text_size=size.tiny)
            row += 1

        if t2Valid
            table.cell(formulaTable, 0, row, "T2", text_color=color.aqua, text_size=size.tiny)
            profitFormula = str.tostring(positionSize, "#.##") + " × " + str.tostring(t2Distance, format.mintick)
            table.cell(formulaTable, 1, row, profitFormula, text_color=color.white, text_size=size.tiny)
            table.cell(formulaTable, 2, row, "$" + str.tostring(t2Profit, "#,###.##"), text_color=color.lime, text_size=size.tiny)
            row += 1

        if t3Valid
            table.cell(formulaTable, 0, row, "T3", text_color=color.aqua, text_size=size.tiny)
            profitFormula = str.tostring(positionSize, "#.##") + " × " + str.tostring(t3Distance, format.mintick)
            table.cell(formulaTable, 1, row, profitFormula, text_color=color.white, text_size=size.tiny)
            table.cell(formulaTable, 2, row, "$" + str.tostring(t3Profit, "#,###.##"), text_color=color.lime, text_size=size.tiny)

// =============================================================================
// R:R SUMMARY TABLE (Bottom)
// =============================================================================

var table rrTable = table.new(position.bottom_center, 7, 3, bgcolor=color.new(color.black, 85), border_width=1)

if barstate.islast and showRRTable and validTrade and stopIsValid
    // Header row
    table.cell(rrTable, 0, 0, "RISK", text_color=color.red, text_size=size.tiny, bgcolor=color.new(color.red, 70))
    table.cell(rrTable, 1, 0, "T1", text_color=color.aqua, text_size=size.tiny, bgcolor=color.new(color.teal, 70))
    table.cell(rrTable, 2, 0, "T2", text_color=color.aqua, text_size=size.tiny, bgcolor=color.new(color.teal, 70))
    table.cell(rrTable, 3, 0, "T3", text_color=color.aqua, text_size=size.tiny, bgcolor=color.new(color.teal, 70))
    table.cell(rrTable, 4, 0, "R:R 1", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.blue, 70))
    table.cell(rrTable, 5, 0, "R:R 2", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.blue, 70))
    table.cell(rrTable, 6, 0, "R:R 3", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.blue, 70))

    // Price row
    table.cell(rrTable, 0, 1, str.tostring(stopLossPrice, format.mintick), text_color=color.red, text_size=size.tiny)
    table.cell(rrTable, 1, 1, t1Valid ? str.tostring(target1Price, format.mintick) : "---", text_color=t1Valid ? color.lime : color.gray, text_size=size.tiny)
    table.cell(rrTable, 2, 1, t2Valid ? str.tostring(target2Price, format.mintick) : "---", text_color=t2Valid ? color.lime : color.gray, text_size=size.tiny)
    table.cell(rrTable, 3, 1, t3Valid ? str.tostring(target3Price, format.mintick) : "---", text_color=t3Valid ? color.lime : color.gray, text_size=size.tiny)

    rr1Color = t1RR >= 2 ? color.lime : (t1RR >= 1 ? color.yellow : color.red)
    rr2Color = t2RR >= 2 ? color.lime : (t2RR >= 1 ? color.yellow : color.red)
    rr3Color = t3RR >= 2 ? color.lime : (t3RR >= 1 ? color.yellow : color.red)

    table.cell(rrTable, 4, 1, t1Valid ? "1:" + str.tostring(t1RR, "#.##") : "---", text_color=t1Valid ? rr1Color : color.gray, text_size=size.tiny)
    table.cell(rrTable, 5, 1, t2Valid ? "1:" + str.tostring(t2RR, "#.##") : "---", text_color=t2Valid ? rr2Color : color.gray, text_size=size.tiny)
    table.cell(rrTable, 6, 1, t3Valid ? "1:" + str.tostring(t3RR, "#.##") : "---", text_color=t3Valid ? rr3Color : color.gray, text_size=size.tiny)

    // Profit row
    table.cell(rrTable, 0, 2, "-$" + str.tostring(riskAmount, "#.##"), text_color=color.red, text_size=size.tiny)
    table.cell(rrTable, 1, 2, t1Valid ? "+$" + str.tostring(t1Profit, "#.##") : "---", text_color=t1Valid ? color.lime : color.gray, text_size=size.tiny)
    table.cell(rrTable, 2, 2, t2Valid ? "+$" + str.tostring(t2Profit, "#.##") : "---", text_color=t2Valid ? color.lime : color.gray, text_size=size.tiny)
    table.cell(rrTable, 3, 2, t3Valid ? "+$" + str.tostring(t3Profit, "#.##") : "---", text_color=t3Valid ? color.lime : color.gray, text_size=size.tiny)
    table.cell(rrTable, 4, 2, "", text_size=size.tiny)
    table.cell(rrTable, 5, 2, "", text_size=size.tiny)
    table.cell(rrTable, 6, 2, "", text_size=size.tiny)

// =============================================================================
// DRAW LINES ON CHART
// =============================================================================

var line entryLine = na
var line stopLine = na
var line t1Line = na
var line t2Line = na
var line t3Line = na
var label entryLabel = na
var label stopLabel = na
var label t1Label = na
var label t2Label = na
var label t3Label = na

if barstate.islast and showLines
    // Clean up
    line.delete(entryLine)
    line.delete(stopLine)
    line.delete(t1Line)
    line.delete(t2Line)
    line.delete(t3Line)
    label.delete(entryLabel)
    label.delete(stopLabel)
    label.delete(t1Label)
    label.delete(t2Label)
    label.delete(t3Label)

    lineLen = 50

    // Entry line
    if validEntry
        entryColor = tradeDirection == "Long" ? color.lime : color.red
        entryLine := line.new(bar_index - lineLen, entryPrice, bar_index + 10, entryPrice,
            xloc.bar_index, extend.none, entryColor, line.style_solid, 2)
        entryLabel := label.new(bar_index + 12, entryPrice, "ENTRY " + str.tostring(entryPrice, format.mintick),
            xloc.bar_index, yloc.price, color.new(entryColor, 70), label.style_label_left, entryColor, size.small)

    // Stop line
    if validStop
        stopLine := line.new(bar_index - lineLen, stopLossPrice, bar_index + 10, stopLossPrice,
            xloc.bar_index, extend.none, color.red, line.style_dashed, 2)
        stopLabel := label.new(bar_index + 12, stopLossPrice, "STOP " + str.tostring(stopLossPrice, format.mintick) + " (-$" + str.tostring(riskAmount, "#.##") + ")",
            xloc.bar_index, yloc.price, color.new(color.red, 70), label.style_label_left, color.red, size.small)

    // Target lines
    if t1Valid
        t1Line := line.new(bar_index - lineLen, target1Price, bar_index + 10, target1Price,
            xloc.bar_index, extend.none, color.teal, line.style_dotted, 2)
        t1Label := label.new(bar_index + 12, target1Price, "T1 " + str.tostring(target1Price, format.mintick) + " (1:" + str.tostring(t1RR, "#.#") + " +$" + str.tostring(t1Profit, "#.##") + ")",
            xloc.bar_index, yloc.price, color.new(color.teal, 70), label.style_label_left, color.teal, size.small)

    if t2Valid
        t2Line := line.new(bar_index - lineLen, target2Price, bar_index + 10, target2Price,
            xloc.bar_index, extend.none, color.blue, line.style_dotted, 2)
        t2Label := label.new(bar_index + 12, target2Price, "T2 " + str.tostring(target2Price, format.mintick) + " (1:" + str.tostring(t2RR, "#.#") + " +$" + str.tostring(t2Profit, "#.##") + ")",
            xloc.bar_index, yloc.price, color.new(color.blue, 70), label.style_label_left, color.blue, size.small)

    if t3Valid
        t3Line := line.new(bar_index - lineLen, target3Price, bar_index + 10, target3Price,
            xloc.bar_index, extend.none, color.purple, line.style_dotted, 2)
        t3Label := label.new(bar_index + 12, target3Price, "T3 " + str.tostring(target3Price, format.mintick) + " (1:" + str.tostring(t3RR, "#.#") + " +$" + str.tostring(t3Profit, "#.##") + ")",
            xloc.bar_index, yloc.price, color.new(color.purple, 70), label.style_label_left, color.purple, size.small)

// =============================================================================
// DATA WINDOW PLOTS
// =============================================================================

plot(riskAmount, "Risk Amount ($)", display=display.data_window)
plot(positionSize, "Position Size", display=display.data_window)
plot(lotSize, "Lot Size", display=display.data_window)
plot(t1RR, "T1 R:R", display=display.data_window)
plot(t2RR, "T2 R:R", display=display.data_window)
plot(t3RR, "T3 R:R", display=display.data_window)
