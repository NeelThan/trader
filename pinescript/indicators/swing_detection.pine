// Swing Detection & Editable Pivot Points with Fibonacci Levels
// Matches Workflow V2 backend algorithm (trader/pivots.py, trader/fibonacci.py)
//
// Algorithm:
// 1. Swing High: high[i] > ALL highs in [i-lookback, i+lookback]
// 2. Swing Low: low[i] < ALL lows in [i-lookback, i+lookback]
// 3. Alternation: consecutive same-type pivots keep most extreme
// 4. Classification: HH/HL/LH/LL by comparing to previous of same type
//
// Fibonacci Tools:
// - Retracement: Pullback levels within a swing (38.2%, 50%, 61.8%, 78.6%)
// - Extension: Beyond 100% of swing (127.2%, 161.8%, 261.8%)
// - Projection: 3-point ABC pattern projection from C
// - Expansion: Range expansion from pivot B

//@version=6
indicator("Swing Detection & Fibonacci Levels", overlay=true, max_labels_count=500, max_lines_count=500)

// =============================================================================
// INPUTS
// =============================================================================

grpDetect = "Detection"
lookback = input.int(5, "Lookback", minval=2, maxval=20, group=grpDetect,
    tooltip="Bars to check on each side. Higher = fewer, more significant pivots.")

grpDisplay = "Display"
showSwingLabels = input.bool(true, "Show HH/HL/LH/LL Labels", group=grpDisplay)
showPriceLabels = input.bool(true, "Show Price Labels", group=grpDisplay)
showLines = input.bool(true, "Show Connecting Lines", group=grpDisplay)
showTable = input.bool(true, "Show Pivot Table", group=grpDisplay)
maxPivots = input.int(20, "Max Pivots to Display", minval=5, maxval=50, group=grpDisplay)

grpColors = "Colors"
colBullish = input.color(color.lime, "Bullish (HH/HL)", group=grpColors)
colBearish = input.color(color.red, "Bearish (LH/LL)", group=grpColors)
colLine = input.color(color.gray, "Connecting Lines", group=grpColors)

grpEdit = "Editable Pivots (0 = auto-detect)"
editPivotA = input.float(0.0, "Override Pivot A (newest)", group=grpEdit)
editPivotB = input.float(0.0, "Override Pivot B", group=grpEdit)
editPivotC = input.float(0.0, "Override Pivot C", group=grpEdit)

grpFib = "Fibonacci Levels"
showRetracement = input.bool(true, "Show Retracement Levels", group=grpFib)
showExtension = input.bool(true, "Show Extension Levels", group=grpFib)
showProjection = input.bool(true, "Show Projection Levels", group=grpFib)
showExpansion = input.bool(true, "Show Expansion Levels", group=grpFib)
extendFibLines = input.bool(true, "Extend Lines to Right", group=grpFib)

grpFibColors = "Fibonacci Colors"
colRetracement = input.color(color.blue, "Retracement", group=grpFibColors)
colExtension = input.color(color.purple, "Extension", group=grpFibColors)
colProjection = input.color(color.orange, "Projection", group=grpFibColors)
colExpansion = input.color(color.teal, "Expansion", group=grpFibColors)

grpFibRatios = "Fibonacci Ratios"
showFib382 = input.bool(true, "38.2%", group=grpFibRatios, inline="ret1")
showFib500 = input.bool(true, "50%", group=grpFibRatios, inline="ret1")
showFib618 = input.bool(true, "61.8%", group=grpFibRatios, inline="ret1")
showFib786 = input.bool(true, "78.6%", group=grpFibRatios, inline="ret1")
showExt1272 = input.bool(true, "127.2%", group=grpFibRatios, inline="ext1")
showExt1618 = input.bool(true, "161.8%", group=grpFibRatios, inline="ext1")
showExt2618 = input.bool(true, "261.8%", group=grpFibRatios, inline="ext1")

grpTrend = "Trend Detection"
rsiPeriod = input.int(14, "RSI Period", minval=2, maxval=50, group=grpTrend)
macdFast = input.int(12, "MACD Fast", minval=2, maxval=50, group=grpTrend)
macdSlow = input.int(26, "MACD Slow", minval=2, maxval=100, group=grpTrend)
macdSignalPeriod = input.int(9, "MACD Signal", minval=2, maxval=50, group=grpTrend)
swingWeight = input.float(0.4, "Swing Weight", minval=0, maxval=1, step=0.1, group=grpTrend)
rsiWeight = input.float(0.3, "RSI Weight", minval=0, maxval=1, step=0.1, group=grpTrend)
macdWeight = input.float(0.3, "MACD Weight", minval=0, maxval=1, step=0.1, group=grpTrend)

// =============================================================================
// USER-DEFINED TYPE
// =============================================================================

type Pivot
    int     t           // time (for xloc.bar_time)
    int     bar         // bar_index
    float   price       // pivot price
    bool    isHigh      // true = high pivot, false = low pivot
    string  swingType   // "HH", "HL", "LH", "LL", or ""

type FibLevel
    float   price       // calculated price level
    float   ratio       // the Fibonacci ratio (0.382, 0.618, etc.)
    string  label       // display label ("38.2%", "61.8%", etc.)
    string  fibType     // "RET", "EXT", "PROJ", "EXP"

// =============================================================================
// PIVOT DETECTION (matches backend _is_swing_high/_is_swing_low)
// =============================================================================

// Check if bar at offset is a swing high
isSwingHigh(int offset) =>
    if offset < lookback
        false
    else
        result = true
        pivotVal = high[offset]
        for i = 1 to lookback
            if high[offset - i] >= pivotVal or high[offset + i] >= pivotVal
                result := false
                break
        result

// Check if bar at offset is a swing low
isSwingLow(int offset) =>
    if offset < lookback
        false
    else
        result = true
        pivotVal = low[offset]
        for i = 1 to lookback
            if low[offset - i] <= pivotVal or low[offset + i] <= pivotVal
                result := false
                break
        result

// =============================================================================
// FIBONACCI CALCULATION FUNCTIONS
// Matches backend trader/fibonacci.py formulas
// =============================================================================

// Determine swing direction from latest pivot types
// Returns: "down" if ended on a low (HL/LL), "up" if ended on high (HH/LH)
getSwingDirection(array<Pivot> pivotsArr) =>
    if array.size(pivotsArr) < 1
        "unknown"
    else
        lastPivot = array.get(pivotsArr, array.size(pivotsArr) - 1)
        lastPivot.isHigh ? "up" : "down"

// Calculate retracement levels
// BUY (swing down): Level = High - (Range × Ratio)
// SELL (swing up): Level = Low + (Range × Ratio)
calcRetracement(float highPrice, float lowPrice, string direction, float ratio) =>
    priceRange = highPrice - lowPrice
    direction == "down" ? highPrice - (priceRange * ratio) : lowPrice + (priceRange * ratio)

// Calculate extension levels (same formula, ratios > 1.0)
// BUY: Level = High - (Range × Ratio)
// SELL: Level = Low + (Range × Ratio)
calcExtension(float highPrice, float lowPrice, string direction, float ratio) =>
    priceRange = highPrice - lowPrice
    direction == "down" ? highPrice - (priceRange * ratio) : lowPrice + (priceRange * ratio)

// Calculate projection levels (3-point: A, B, C)
// BUY: Level = C - (|A-B| × Ratio)
// SELL: Level = C + (|A-B| × Ratio)
calcProjection(float pointA, float pointB, float pointC, string direction, float ratio) =>
    swing = math.abs(pointA - pointB)
    direction == "down" ? pointC - (swing * ratio) : pointC + (swing * ratio)

// Calculate expansion levels (2-point: A, B)
// BUY: Level = B - (|A-B| × Ratio)
// SELL: Level = B + (|A-B| × Ratio)
calcExpansion(float pointA, float pointB, string direction, float ratio) =>
    priceRange = math.abs(pointA - pointB)
    direction == "down" ? pointB - (priceRange * ratio) : pointB + (priceRange * ratio)

// =============================================================================
// TREND DETECTION (matches frontend use-trend-alignment.ts)
// Weight: Swing 40%, RSI 30%, MACD 30%
// =============================================================================

// Calculate RSI
rsiValue = ta.rsi(close, rsiPeriod)

// Calculate MACD
[macdLine, signalLine, histLine] = ta.macd(close, macdFast, macdSlow, macdSignalPeriod)

// Analyze RSI signal: >60 bullish, <40 bearish, >50 mild bullish, <50 mild bearish
getRSISignal() =>
    if rsiValue >= 60
        1.0  // Strong bullish
    else if rsiValue <= 40
        -1.0  // Strong bearish
    else if rsiValue > 50
        0.5  // Mild bullish
    else if rsiValue < 50
        -0.5  // Mild bearish
    else
        0.0  // Neutral (exactly 50)

// Analyze MACD signal: histogram > 0 bullish, < 0 bearish
getMACDSignal() =>
    if histLine > 0
        1.0  // Bullish
    else if histLine < 0
        -1.0  // Bearish
    else
        0.0  // Neutral

// =============================================================================
// STATE & STORAGE
// =============================================================================

var array<Pivot> pivots = array.new<Pivot>()
var float lastHighPrice = na
var float lastLowPrice = na
var string lastPivotType = ""  // "high" or "low"

// Detect at lookback offset (confirmed pivot)
foundHigh = isSwingHigh(lookback)
foundLow = isSwingLow(lookback)

pivotTime = time[lookback]
pivotBar = bar_index - lookback
highPrice = high[lookback]
lowPrice = low[lookback]

// =============================================================================
// ALTERNATION ENFORCEMENT (matches backend _enforce_alternation)
// =============================================================================

addHigh = false
addLow = false

if foundHigh
    if lastPivotType == "high"
        // Same type - only add if higher (replace last)
        if highPrice > lastHighPrice and array.size(pivots) > 0
            array.pop(pivots)
            addHigh := true
    else
        addHigh := true

if foundLow
    if lastPivotType == "low"
        // Same type - only add if lower (replace last)
        if lowPrice < lastLowPrice and array.size(pivots) > 0
            array.pop(pivots)
            addLow := true
    else
        addLow := true

// =============================================================================
// CLASSIFICATION (matches backend classify_swings)
// =============================================================================

if addHigh
    string swing = ""
    if not na(lastHighPrice)
        swing := highPrice > lastHighPrice ? "HH" : "LH"

    newPivot = Pivot.new(pivotTime, pivotBar, highPrice, true, swing)
    array.push(pivots, newPivot)

    lastHighPrice := highPrice
    lastPivotType := "high"

if addLow
    string swing = ""
    if not na(lastLowPrice)
        swing := lowPrice > lastLowPrice ? "HL" : "LL"

    newPivot = Pivot.new(pivotTime, pivotBar, lowPrice, false, swing)
    array.push(pivots, newPivot)

    lastLowPrice := lowPrice
    lastPivotType := "low"

// Limit array size
while array.size(pivots) > maxPivots
    array.shift(pivots)

// =============================================================================
// GET EDITABLE PIVOT VALUES
// =============================================================================

int numPivots = array.size(pivots)

// Get raw detected values
float rawA = numPivots >= 1 ? array.get(pivots, numPivots - 1).price : na
float rawB = numPivots >= 2 ? array.get(pivots, numPivots - 2).price : na
float rawC = numPivots >= 3 ? array.get(pivots, numPivots - 3).price : na

// Apply overrides
float pivotA = editPivotA != 0.0 ? editPivotA : rawA
float pivotB = editPivotB != 0.0 ? editPivotB : rawB
float pivotC = editPivotC != 0.0 ? editPivotC : rawC

// =============================================================================
// VISUALIZATION - Draw on last confirmed bar (stable positioning)
// =============================================================================

if barstate.islastconfirmedhistory
    Pivot prevPivot = na

    for i = 0 to numPivots - 1
        p = array.get(pivots, i)

        // Determine color
        isBullish = p.swingType == "HH" or p.swingType == "HL"
        col = isBullish ? colBullish : (p.swingType == "" ? color.blue : colBearish)
        textCol = isBullish ? color.black : color.white

        // ABC label for most recent 3
        string abcLabel = ""
        if i == numPivots - 1
            abcLabel := " [A]"
        else if i == numPivots - 2
            abcLabel := " [B]"
        else if i == numPivots - 3
            abcLabel := " [C]"

        // Draw swing type label
        if showSwingLabels and p.swingType != ""
            label.new(
                p.t, p.price,
                p.swingType,
                xloc.bar_time,
                yloc.price,
                color.new(col, 70),
                p.isHigh ? label.style_label_down : label.style_label_up,
                textCol,
                size.small)

        // Draw price label
        if showPriceLabels
            label.new(
                p.t, p.price,
                str.tostring(p.price, format.mintick) + abcLabel,
                xloc.bar_time,
                yloc.price,
                color.new(col, 85),
                p.isHigh ? label.style_label_down : label.style_label_up,
                col,
                size.tiny)

        // Draw connecting line
        if showLines and not na(prevPivot)
            line.new(
                prevPivot.t, prevPivot.price,
                p.t, p.price,
                xloc.bar_time,
                extend.none,
                colLine,
                line.style_solid,
                1)

        prevPivot := p

// =============================================================================
// TREND ANALYSIS FUNCTIONS
// Matches Workflow V2 trend alignment logic
// =============================================================================

// Analyze swing trend from detected pivots (HH/HL = bullish, LH/LL = bearish)
getSwingTrend() =>
    bullishCount = 0
    bearishCount = 0

    for i = 0 to array.size(pivots) - 1
        p = array.get(pivots, i)
        if p.swingType == "HH" or p.swingType == "HL"
            bullishCount += 1
        else if p.swingType == "LH" or p.swingType == "LL"
            bearishCount += 1

    total = bullishCount + bearishCount
    if total == 0
        0.0  // Neutral
    else
        ratio = bullishCount / total
        if ratio >= 0.6
            1.0  // Bullish
        else if ratio <= 0.4
            -1.0  // Bearish
        else
            0.0  // Neutral/Ranging

// Calculate combined trend score
calcTrendScore() =>
    swingSignal = getSwingTrend()
    rsiSignal = getRSISignal()
    macdSignal = getMACDSignal()

    // Weighted sum
    score = (swingSignal * swingWeight) + (rsiSignal * rsiWeight) + (macdSignal * macdWeight)
    score

// Get trend direction string
getTrendDirection(float score) =>
    if score >= 0.35
        "BULLISH"
    else if score <= -0.35
        "BEARISH"
    else
        "RANGING"

// Get trend color
getTrendColor(string trend) =>
    trend == "BULLISH" ? color.lime : (trend == "BEARISH" ? color.red : color.gray)

// =============================================================================
// PIVOT & TREND TABLE (combined)
// =============================================================================

var table tbl = table.new(position.top_right, 3, 12, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast and showTable
    // === TREND SECTION ===
    // Calculate signals
    swingSignal = getSwingTrend()
    rsiSignal = getRSISignal()
    macdSignal = getMACDSignal()
    trendScore = calcTrendScore()
    trendDir = getTrendDirection(trendScore)
    trendCol = getTrendColor(trendDir)

    // Trend header
    table.cell(tbl, 0, 0, "TREND", text_color=color.white, text_size=size.small, bgcolor=color.new(trendCol, 60))
    table.cell(tbl, 1, 0, trendDir, text_color=trendCol, text_size=size.small, bgcolor=color.new(trendCol, 80))
    confidence = math.abs(trendScore) * 100
    table.cell(tbl, 2, 0, str.tostring(confidence, "#") + "%", text_color=trendCol, text_size=size.small, bgcolor=color.new(trendCol, 80))

    // Swing row
    swingText = swingSignal >= 0.5 ? "Bullish" : (swingSignal <= -0.5 ? "Bearish" : "Neutral")
    swingCol = swingSignal >= 0.5 ? color.lime : (swingSignal <= -0.5 ? color.red : color.gray)
    table.cell(tbl, 0, 1, "Swing", text_color=color.white, text_size=size.tiny)
    table.cell(tbl, 1, 1, swingText, text_color=swingCol, text_size=size.tiny)
    table.cell(tbl, 2, 1, str.tostring(swingWeight * 100, "#") + "%", text_color=color.gray, text_size=size.tiny)

    // RSI row
    rsiText = rsiSignal >= 0.5 ? "Bullish" : (rsiSignal <= -0.5 ? "Bearish" : "Neutral")
    rsiCol = rsiSignal >= 0.5 ? color.lime : (rsiSignal <= -0.5 ? color.red : color.gray)
    table.cell(tbl, 0, 2, "RSI", text_color=color.white, text_size=size.tiny)
    table.cell(tbl, 1, 2, rsiText + " (" + str.tostring(rsiValue, "#.#") + ")", text_color=rsiCol, text_size=size.tiny)
    table.cell(tbl, 2, 2, str.tostring(rsiWeight * 100, "#") + "%", text_color=color.gray, text_size=size.tiny)

    // MACD row
    macdText = macdSignal >= 0.5 ? "Bullish" : (macdSignal <= -0.5 ? "Bearish" : "Neutral")
    macdCol = macdSignal >= 0.5 ? color.lime : (macdSignal <= -0.5 ? color.red : color.gray)
    table.cell(tbl, 0, 3, "MACD", text_color=color.white, text_size=size.tiny)
    table.cell(tbl, 1, 3, macdText, text_color=macdCol, text_size=size.tiny)
    table.cell(tbl, 2, 3, str.tostring(macdWeight * 100, "#") + "%", text_color=color.gray, text_size=size.tiny)

    // Separator
    table.cell(tbl, 0, 4, "", text_size=size.tiny)
    table.cell(tbl, 1, 4, "", text_size=size.tiny)
    table.cell(tbl, 2, 4, "", text_size=size.tiny)

    // === PIVOT SECTION ===
    // Header
    table.cell(tbl, 0, 5, "Pivot", text_color=color.white, text_size=size.small)
    table.cell(tbl, 1, 5, "Detected", text_color=color.white, text_size=size.small)
    table.cell(tbl, 2, 5, "Override", text_color=color.white, text_size=size.small)

    // Get types for display
    string typeA = numPivots >= 1 ? array.get(pivots, numPivots - 1).swingType : ""
    string typeB = numPivots >= 2 ? array.get(pivots, numPivots - 2).swingType : ""
    string typeC = numPivots >= 3 ? array.get(pivots, numPivots - 3).swingType : ""

    // Pivot A
    table.cell(tbl, 0, 6, "A " + typeA, text_color=color.yellow, text_size=size.small)
    table.cell(tbl, 1, 6, na(rawA) ? "—" : str.tostring(rawA, format.mintick), text_color=color.white, text_size=size.small)
    table.cell(tbl, 2, 6, editPivotA == 0 ? "—" : str.tostring(editPivotA, format.mintick),
        text_color=editPivotA != 0 ? color.yellow : color.gray, text_size=size.small)

    // Pivot B
    table.cell(tbl, 0, 7, "B " + typeB, text_color=color.yellow, text_size=size.small)
    table.cell(tbl, 1, 7, na(rawB) ? "—" : str.tostring(rawB, format.mintick), text_color=color.white, text_size=size.small)
    table.cell(tbl, 2, 7, editPivotB == 0 ? "—" : str.tostring(editPivotB, format.mintick),
        text_color=editPivotB != 0 ? color.yellow : color.gray, text_size=size.small)

    // Pivot C
    table.cell(tbl, 0, 8, "C " + typeC, text_color=color.yellow, text_size=size.small)
    table.cell(tbl, 1, 8, na(rawC) ? "—" : str.tostring(rawC, format.mintick), text_color=color.white, text_size=size.small)
    table.cell(tbl, 2, 8, editPivotC == 0 ? "—" : str.tostring(editPivotC, format.mintick),
        text_color=editPivotC != 0 ? color.yellow : color.gray, text_size=size.small)

    // Info
    table.cell(tbl, 0, 9, "Lookback", text_color=color.gray, text_size=size.tiny)
    table.cell(tbl, 1, 9, str.tostring(lookback), text_color=color.white, text_size=size.tiny)
    table.cell(tbl, 2, 9, "", text_size=size.tiny)

    table.cell(tbl, 0, 10, "Total", text_color=color.gray, text_size=size.tiny)
    table.cell(tbl, 1, 10, str.tostring(numPivots), text_color=color.white, text_size=size.tiny)
    table.cell(tbl, 2, 10, "", text_size=size.tiny)

    // Instructions
    table.cell(tbl, 0, 11, "Edit in Settings →", text_color=color.gray, text_size=size.tiny)
    table.cell(tbl, 1, 11, "Editable Pivots", text_color=color.gray, text_size=size.tiny)
    table.cell(tbl, 2, 11, "", text_size=size.tiny)

// =============================================================================
// FIBONACCI LEVELS VISUALIZATION
// =============================================================================

// Persistent line arrays for each Fibonacci type
var array<line> retLines = array.new<line>()
var array<label> retLabels = array.new<label>()
var array<line> extLines = array.new<line>()
var array<label> extLabels = array.new<label>()
var array<line> projLines = array.new<line>()
var array<label> projLabels = array.new<label>()
var array<line> expLines = array.new<line>()
var array<label> expLabels = array.new<label>()

// Clear previous Fibonacci drawings
clearFibArrays() =>
    for ln in retLines
        line.delete(ln)
    array.clear(retLines)
    for lb in retLabels
        label.delete(lb)
    array.clear(retLabels)
    for ln in extLines
        line.delete(ln)
    array.clear(extLines)
    for lb in extLabels
        label.delete(lb)
    array.clear(extLabels)
    for ln in projLines
        line.delete(ln)
    array.clear(projLines)
    for lb in projLabels
        label.delete(lb)
    array.clear(projLabels)
    for ln in expLines
        line.delete(ln)
    array.clear(expLines)
    for lb in expLabels
        label.delete(lb)
    array.clear(expLabels)

// Draw a single Fibonacci level line and label
drawFibLevel(float priceLevel, string labelText, color col, string fibType, int startBar, int endBar) =>
    if not na(priceLevel)
        extendStyle = extendFibLines ? extend.right : extend.none
        newLine = line.new(startBar, priceLevel, endBar, priceLevel,
            xloc.bar_index, extendStyle, col, line.style_dashed, 1)
        newLabel = label.new(endBar, priceLevel, labelText + " " + str.tostring(priceLevel, format.mintick),
            xloc.bar_index, yloc.price, color.new(col, 80), label.style_label_left, col, size.tiny)

        if fibType == "RET"
            array.push(retLines, newLine)
            array.push(retLabels, newLabel)
        else if fibType == "EXT"
            array.push(extLines, newLine)
            array.push(extLabels, newLabel)
        else if fibType == "PROJ"
            array.push(projLines, newLine)
            array.push(projLabels, newLabel)
        else if fibType == "EXP"
            array.push(expLines, newLine)
            array.push(expLabels, newLabel)

// Draw Fibonacci levels on the last bar
if barstate.islast and numPivots >= 2
    // Clear old drawings
    clearFibArrays()

    // Determine swing direction for buy/sell logic
    direction = getSwingDirection(pivots)

    // Get high/low from A-B range (using the 2 most recent pivots)
    latestPivot = array.get(pivots, numPivots - 1)
    prevPivot = array.get(pivots, numPivots - 2)

    // Find high and low between A and B
    rangeHigh = math.max(pivotA, pivotB)
    rangeLow = math.min(pivotA, pivotB)

    // Calculate bar range for drawing
    startBar = prevPivot.bar
    endBar = bar_index

    // =================================
    // RETRACEMENT LEVELS (38.2%, 50%, 61.8%, 78.6%)
    // =================================
    if showRetracement and not na(rangeHigh) and not na(rangeLow)
        if showFib382
            level382 = calcRetracement(rangeHigh, rangeLow, direction, 0.382)
            drawFibLevel(level382, "38.2%", colRetracement, "RET", startBar, endBar)
        if showFib500
            level500 = calcRetracement(rangeHigh, rangeLow, direction, 0.500)
            drawFibLevel(level500, "50%", colRetracement, "RET", startBar, endBar)
        if showFib618
            level618 = calcRetracement(rangeHigh, rangeLow, direction, 0.618)
            drawFibLevel(level618, "61.8%", colRetracement, "RET", startBar, endBar)
        if showFib786
            level786 = calcRetracement(rangeHigh, rangeLow, direction, 0.786)
            drawFibLevel(level786, "78.6%", colRetracement, "RET", startBar, endBar)

    // =================================
    // EXTENSION LEVELS (127.2%, 161.8%, 261.8%)
    // =================================
    if showExtension and not na(rangeHigh) and not na(rangeLow)
        if showExt1272
            ext1272 = calcExtension(rangeHigh, rangeLow, direction, 1.272)
            drawFibLevel(ext1272, "127.2%", colExtension, "EXT", startBar, endBar)
        if showExt1618
            ext1618 = calcExtension(rangeHigh, rangeLow, direction, 1.618)
            drawFibLevel(ext1618, "161.8%", colExtension, "EXT", startBar, endBar)
        if showExt2618
            ext2618 = calcExtension(rangeHigh, rangeLow, direction, 2.618)
            drawFibLevel(ext2618, "261.8%", colExtension, "EXT", startBar, endBar)

    // =================================
    // PROJECTION LEVELS (61.8%, 78.6%, 100%, 127.2%, 161.8%)
    // Requires 3 pivot points (A, B, C)
    // =================================
    if showProjection and numPivots >= 3 and not na(pivotA) and not na(pivotB) and not na(pivotC)
        // For projection, we use C as newest, B as middle, A as oldest
        // Direction is based on current swing (already calculated)
        proj618 = calcProjection(pivotC, pivotB, pivotA, direction, 0.618)
        drawFibLevel(proj618, "P 61.8%", colProjection, "PROJ", startBar, endBar)

        proj786 = calcProjection(pivotC, pivotB, pivotA, direction, 0.786)
        drawFibLevel(proj786, "P 78.6%", colProjection, "PROJ", startBar, endBar)

        proj1000 = calcProjection(pivotC, pivotB, pivotA, direction, 1.000)
        drawFibLevel(proj1000, "P 100%", colProjection, "PROJ", startBar, endBar)

        proj1272 = calcProjection(pivotC, pivotB, pivotA, direction, 1.272)
        drawFibLevel(proj1272, "P 127.2%", colProjection, "PROJ", startBar, endBar)

        proj1618 = calcProjection(pivotC, pivotB, pivotA, direction, 1.618)
        drawFibLevel(proj1618, "P 161.8%", colProjection, "PROJ", startBar, endBar)

    // =================================
    // EXPANSION LEVELS (38.2%, 50%, 61.8%, 100%, 161.8%)
    // =================================
    if showExpansion and not na(pivotA) and not na(pivotB)
        // Expansion projects from B (most recent of the A-B pair)
        exp382 = calcExpansion(pivotB, pivotA, direction, 0.382)
        drawFibLevel(exp382, "E 38.2%", colExpansion, "EXP", startBar, endBar)

        exp500 = calcExpansion(pivotB, pivotA, direction, 0.500)
        drawFibLevel(exp500, "E 50%", colExpansion, "EXP", startBar, endBar)

        exp618 = calcExpansion(pivotB, pivotA, direction, 0.618)
        drawFibLevel(exp618, "E 61.8%", colExpansion, "EXP", startBar, endBar)

        exp1000 = calcExpansion(pivotB, pivotA, direction, 1.000)
        drawFibLevel(exp1000, "E 100%", colExpansion, "EXP", startBar, endBar)

        exp1618 = calcExpansion(pivotB, pivotA, direction, 1.618)
        drawFibLevel(exp1618, "E 161.8%", colExpansion, "EXP", startBar, endBar)

